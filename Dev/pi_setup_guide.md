# ğŸ“ ë¼ì¦ˆë² ë¦¬íŒŒì´ 3 B+ KWS ì„¸íŒ… ê°€ì´ë“œ (Phase 2)

PCì—ì„œ ì„±ê³µì ìœ¼ë¡œ ê²€ì¦ëœ KWS(Keyword Spotting) íŒŒì´í”„ë¼ì¸ì„ ë¼ì¦ˆë² ë¦¬íŒŒì´ì— ì´ì‹í•˜ê¸° ìœ„í•œ ì™„ë²½í•œ ê°€ì´ë“œì…ë‹ˆë‹¤. 

ìš°ë¦¬ê°€ ë§Œë“  ëª¨ë¸ì€ í•™ìŠµ ì‹œ TensorFlow 1.15ì˜ ë‚´ì¥ C++ ëª¨ë“ˆ(`contrib_audio`)ì„ ì‚¬ìš©í•˜ì—¬ ì˜¤ë””ì˜¤ íŠ¹ì§•(MFCC)ì„ ì¶”ì¶œí–ˆìŠµë‹ˆë‹¤. ì´ ì—°ì‚°ì€ í‘œì¤€ TFLite ëŸ°íƒ€ì„ì— í˜¸í™˜ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ë¼ì¦ˆë² ë¦¬íŒŒì´ì—ë„ ê°€ë²¼ìš´ **ì„ë² ë””ë“œìš© TensorFlow 1.15**ë¥¼ ì„¤ì¹˜í•´ì•¼ ì™„ë²½í•˜ê²Œ ë™ì¼í•œ ì„±ëŠ¥ì„ ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

ì´ ê°€ì´ë“œëŠ” ì‚¬ìš©ìì˜ ìµœì‹  OS(Debian 13 Trixie, aarch64, Python 3.13)ë¥¼ **ì¬ì„¤ì¹˜í•˜ì§€ ì•Šê³  ê·¸ëŒ€ë¡œ ìœ ì§€**í•˜ë©´ì„œ, TensorFlow 1.15 êµ¬ë™ì— í•„ìš”í•œ Python 3.7 í™˜ê²½ì„ **Docker ì»¨í…Œì´ë„ˆ**ë¡œ ì•ˆì „í•˜ê²Œ ë„ì›Œì„œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## 1ë‹¨ê³„: ë¼ì¦ˆë² ë¦¬íŒŒì´ì— Docker ì„¤ì¹˜ (í˜¸ìŠ¤íŠ¸ í„°ë¯¸ë„ ì‘ì—…)

í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ìµœì‹  ë¼ì¦ˆë² ë¦¬íŒŒì´ OSì— ì»¨í…Œì´ë„ˆ í™˜ê²½ì„ êµ¬ë™í•˜ê¸° ìœ„í•œ Docker ì—”ì§„ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤. ë¼ì¦ˆë² ë¦¬íŒŒì´ í„°ë¯¸ë„ì—ì„œ ë‹¤ìŒì„ ì‹¤í–‰í•˜ì„¸ìš”.

```bash
# ìµœì‹  íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
sudo apt-get update
sudo apt-get upgrade -y

# Docker ê°„í¸ ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# í˜„ì¬ ì‚¬ìš©ì(kouy956 ë“±)ë¥¼ docker ê·¸ë£¹ì— ì¶”ê°€í•˜ì—¬ sudo ì—†ì´ ì‹¤í–‰ (ì„¤ì • í›„ SSH ì¬ì ‘ì† ê¶Œì¥)
sudo usermod -aG docker $USER
```

---

## 2ë‹¨ê³„: í˜¸ìŠ¤íŠ¸ì— ë§ˆì´í¬ í•˜ë“œì›¨ì–´ í™•ì¸
ë¼ì¦ˆë² ë¦¬íŒŒì´ì— USB ë§ˆì´í¬(ë˜ëŠ” ì˜¤ë””ì˜¤ í–‡)ë¥¼ ê½‚ì€ ë’¤, ë¦¬ëˆ…ìŠ¤ ì»¤ë„ì— ì œëŒ€ë¡œ ì¸ì‹ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
```bash
arecord -l
```
> ëª©ë¡ì— USB ì˜¤ë””ì˜¤ ë””ë°”ì´ìŠ¤ê°€ ë³´ì´ë©´ ì •ìƒì…ë‹ˆë‹¤. (ì¹´ë“œ ë²ˆí˜¸ë¥¼ ê¼­ í™•ì¸í•´ ì£¼ì„¸ìš”. ë‚˜ì¤‘ì— Dockerë¡œ ìŠ¤í”¼ì»¤/ë§ˆì´í¬ ì¥ì¹˜ `/dev/snd` ë¥¼ í†µì§¸ë¡œ ë„˜ê²¨ì¤„ ì˜ˆì •ì…ë‹ˆë‹¤.)

### 2. ë§ˆì´í¬ ì—°ê²° í™•ì¸
USB ë§ˆì´í¬(ë˜ëŠ” ì˜¤ë””ì˜¤ í–‡)ë¥¼ ê½‚ì€ ë’¤, ì¸ì‹ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
```bash
arecord -l
```
> ëª©ë¡ì— USB ì˜¤ë””ì˜¤ ë””ë°”ì´ìŠ¤ê°€ ë³´ì´ë©´ ì •ìƒì…ë‹ˆë‹¤. (ì¹´ë“œ ë²ˆí˜¸ì™€ ë””ë°”ì´ìŠ¤ ë²ˆí˜¸ë¥¼ ê¸°ì–µí•´ë‘ì„¸ìš”. ë³´í†µ `hw:1,0` í˜•ì‹ì…ë‹ˆë‹¤.)

---

## 3ë‹¨ê³„: Dockerfile ì‘ì„± ë° ë¹Œë“œ (ë¼ì¦ˆë² ë¦¬íŒŒì´ ë‚´ë¶€ ì‘ì—…)

ë¼ì¦ˆë² ë¦¬íŒŒì´ ì•ˆì— í”„ë¡œì íŠ¸ í´ë”ë¥¼ ë§Œë“¤ê³ , ë‚´ì¥ë  íŒŒì´ì¬ 3.7 ì»¨í…Œì´ë„ˆ ëª…ì„¸ì„œ(`Dockerfile`)ë¥¼ ì‘ì„±í•©ë‹ˆë‹¤.

```bash
mkdir -p ~/KWS_Project && cd ~/KWS_Project
nano Dockerfile
```

ì•„ë˜ ë‚´ìš©ì„ ë³µì‚¬í•˜ì—¬ `Dockerfile`ì— ë¶™ì—¬ë„£ê³  ì €ì¥(`Ctrl+O`, `Enter`, `Ctrl+X`)í•©ë‹ˆë‹¤.

```dockerfile
# ARM64 ê¸°ë°˜ ë ˆê±°ì‹œ Debian(Python 3.7 í˜¸í™˜) ì´ë¯¸ì§€ ì‚¬ìš©
FROM arm64v8/debian:buster-slim

# ë§ˆì´í¬/ì˜¤ë””ì˜¤ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-dev \
    wget libatlas-base-dev portaudio19-dev \
    alsa-utils gcc \
    && rm -rf /var/lib/apt/lists/*

# íŒŒì´ì¬ pip ìµœì‹ í™”
RUN python3 -m pip install --upgrade pip

# ARM64ìš© TensorFlow 1.15 Wheel ì„¤ì¹˜ (aarch64 ì „ìš© ì‚¬ì „ ë¹Œë“œ íŒŒì¼)
RUN wget https://github.com/lhelontra/tensorflow-on-arm/releases/download/v1.15.2/tensorflow-1.15.2-cp37-none-linux_aarch64.whl
RUN pip3 install tensorflow-1.15.2-cp37-none-linux_aarch64.whl pyaudio

WORKDIR /app
CMD ["python3", "pc_mic_test.py"]
```

ì‘ì„± í›„, í•´ë‹¹ ë””ë ‰í† ë¦¬ì—ì„œ Docker ì´ë¯¸ì§€ë¥¼ ë¹Œë“œí•©ë‹ˆë‹¤. (ì¢…ì†ì„± ë‹¤ìš´ë¡œë“œë¡œ ì¸í•´ ì‹œê°„ì´ ì¢€ ê±¸ë¦½ë‹ˆë‹¤.)
```bash
docker build -t kws-tf1.15 .
```

---

## 4ë‹¨ê³„: íŒŒì¼ ì „ì†¡ ë° Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰

PCì—ì„œ ì™„ì„±ëœ KWS íŒŒì¼ë“¤ì„ ë¼ì¦ˆë² ë¦¬íŒŒì´ì˜ `~/KWS_Project` í´ë”ë¡œ ì „ì†¡í•©ë‹ˆë‹¤. ì „ì†¡ ìˆ˜ë‹¨ìœ¼ë¡œëŠ” FileZilla, WinSCP, ë˜ëŠ” MobaXterm `scp` ê¸°ëŠ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

**ì „ì†¡í•´ì•¼ í•  í•µì‹¬ íŒŒì¼ 2ê°€ì§€:**
1. `work/ds_cnn.tflite` (91KB ëª¨ë¸ íŒŒì¼)
2. `pc_mic_test.py` (ìš°ë¦¬ê°€ PCì—ì„œ ì™„ì„±í•˜ê³  ìµœì í™”í•œ ì‹¤ì‹œê°„ ì¶”ë¡  ìŠ¤í¬ë¦½íŠ¸)

*(ì „ì†¡ ì‹œ `ds_cnn.tflite`ëŠ” ë¼ì¦ˆë² ë¦¬íŒŒì´ì˜ `~/KWS_Project/work/` í´ë” ë‚´ì— ìœ„ì¹˜í•˜ë„ë¡ ê²½ë¡œë¥¼ ë§ì¶°ì£¼ì„¸ìš”.)*

### ğŸš€ ë§ˆì´í¬ íŒ¨ìŠ¤ìŠ¤ë£¨ ì˜µì…˜ìœ¼ë¡œ ì¶”ë¡  ì‹¤í–‰
í•˜ë“œì›¨ì–´ ë§ˆì´í¬ ì œì–´ê¶Œ(`/dev/snd`)ì„ Docker ì•ˆìœ¼ë¡œ ë„˜ê²¨ì£¼ì–´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰ì›í•©ë‹ˆë‹¤.

```bash
cd ~/KWS_Project

# ì˜¤ë””ì˜¤ ê¶Œí•œì„ ì»¨í…Œì´ë„ˆ ë°–ì˜ í•˜ë“œì›¨ì–´ì™€ ì—°ë™í•˜ì—¬ ì‹¤í–‰
docker run -it --rm \
  --device /dev/snd \
  -v $(pwd):/app \
  kws-tf1.15
```

---

## (ì°¸ê³ ) ë§ˆì´í¬ ì—ëŸ¬ ë°œìƒ ì‹œ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
ë§Œì•½ `pc_mic_test.py` ì‹¤í–‰ ì‹œ `[Errno -9998] Invalid number of channels` ë˜ëŠ” `Default Input Device` ê´€ë ¨ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤ë©´, PyAudioì— í•˜ë“œì›¨ì–´ ë§ˆì´í¬ ë²ˆí˜¸ë¥¼ ì§ì ‘ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.

`pc_mic_test.py` íŒŒì¼ ë‚´ì˜ ìŠ¤íŠ¸ë¦¬ë° ì„¸íŒ… ë¼ì¸ì— `input_device_index` ë¶€ë¶„ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

```python
# ìˆ˜ì • ì „
stream = p.open(format=pyaudio.paInt16, ... )

# ìˆ˜ì • í›„: input_device_index ì¶”ê°€ (arecord -l ë¡œ í™•ì¸í•œ ì¹´ë“œ ë²ˆí˜¸ê°€ 1ë²ˆì¼ ë•Œ)
stream = p.open(format=pyaudio.paInt16,
                channels=1,
                rate=SAMPLE_RATE,
                input=True,
                input_device_index=1,  # <--- ì´ ë¶€ë¶„ ì¶”ê°€ (ê¸°ê¸° í™˜ê²½ì— ë§ê²Œ ìˆ«ì ë³€ê²½)
                frames_per_buffer=CHUNK_SIZE)
```
