# π“ freeze.py λ¶„μ„ λ° λ°°ν¬ κµ¬μ΅°

> **νμΌ:** `freeze.py` (218μ¤„)  
> **μ—­ν• :** ν•™μµλ μ²΄ν¬ν¬μΈνΈ(Checkpoint)λ¥Ό λ°°ν¬μ© Frozen Graph(`.pb`)λ΅ λ³€ν™  
> **μ‘μ„±μΌ:** 2026-02-24
> **μµμΆ… μμ •:** 2026-02-28 (λ°°ν¬ μ•„ν‚¤ν…μ² ν™•μ • λ°μ)

---

## 1. ν•µμ‹¬ κ°λ…: μ²΄ν¬ν¬μΈνΈ vs Frozen Graph

### μ²΄ν¬ν¬μΈνΈ(Checkpoint)λ€?
ν•™μµ μ¤‘ **λ¨λΈμ κ°€μ¤‘μΉ(weight)λ¥Ό μ €μ¥ν• νμΌ μ„ΈνΈ**. ν•™μµ μ¬κ°λ‚ μ¶”κ°€ ν•™μµμ— μ‚¬μ©.
```
work/ds_cnn_train/best/
β”β”€β”€ ds_cnn_9687.ckpt-7500.data-00000-of-00001   β† κ°€μ¤‘μΉ λ°μ΄ν„° (μ«μλ“¤)
β”β”€β”€ ds_cnn_9687.ckpt-7500.index                  β† κ°€μ¤‘μΉ μ΄λ¦„ β†” μ„μΉ λ§¤ν•‘
β”β”€β”€ ds_cnn_9687.ckpt-7500.meta                   β† κ·Έλν”„ κµ¬μ΅° (λ…Έλ“, μ—°μ‚° μ •λ³΄)
β””β”€β”€ checkpoint                                    β† μµμ‹  ckpt κ²½λ΅ κΈ°λ΅
```

### λΉ„κµν‘
| κµ¬λ¶„ | μ²΄ν¬ν¬μΈνΈ(`.ckpt`) | Frozen Graph(`.pb`) |
|------|---------------------|---------------------|
| **μ©λ„** | ν•™μµ μ¬κ°, μ¶”κ°€ ν•™μµ | μ¶”λ΅ (Inference) μ „μ© |
| **λ‚΄μ©** | κ°€μ¤‘μΉ + κ·Έλν”„ (λ¶„λ¦¬λ¨) | κ°€μ¤‘μΉκ°€ κ·Έλν”„μ— **λ‚΄μ¥**(frozen) |
| **νμΌ μ** | 3~4κ° | **1κ°** |
| **λ°°ν¬** | β λ¶€μ ν•© | β… μ„λ² λ””λ“μ© (Docker + TF 1.15) |

---

## 2. freeze.py λ‚΄λ¶€ λ™μ‘ (3λ‹¨κ³„)

### Stage 1: μ¶”λ΅ μ© κ·Έλν”„ μƒμ„± (`create_inference_graph`)
ν•™μµ μ‹ μ‚¬μ©λμ§€ μ•λ” λ…Έλ“(Dropout λ“±)λ¥Ό μ μ™Έν•κ³  μ¶”λ΅  μ „μ© νμ΄ν”„λΌμΈ κµ¬μ„±:
`WAV μ…λ ¥ β†’ decode_wav β†’ Spectrogram β†’ MFCC(Fingerprint) β†’ DS-CNN β†’ Softmax`

### Stage 2: μ²΄ν¬ν¬μΈνΈ λ΅λ“
```python
models.load_variables_from_checkpoint(sess, FLAGS.start_checkpoint)
```
`best/` ν΄λ”μ `.ckpt` νμΌμ—μ„ ν•™μµλ κ°€μ¤‘μΉλ¥Ό λ³µμ›ν•©λ‹λ‹¤.

### Stage 3: λ³€μ λ™κ²°(Freeze) λ° μ €μ¥
```python
frozen_graph_def = graph_util.convert_variables_to_constants(sess, sess.graph_def, ['labels_softmax'])
```
λ¨λ“  λ³€μλ¥Ό μƒμλ΅ λ³€ν™ν•μ—¬ λ‹¨μΌ `.pb` νμΌλ΅ μ €μ¥ν•©λ‹λ‹¤.

---

## 3. π” μ‹¬μΈµ λ¶„μ„: Fingerprintμ™€ μ¶”λ΅  μ§€λ¦„κΈΈ

### 3.1 Fingerprint(μ§€λ¬Έ)μ μλ―Έ
μ΄ ν”„λ΅μ νΈμ—μ„ **Fingerprint**λ” μ†λ¦¬λ§μ΄ κ°€μ§„ κ³ μ ν• νΉμ§•μ„ λ””μ§€ν„Έλ΅ λ½‘μ•„λ‚Έ **MFCC** λ°μ΄ν„°λ¥Ό μλ―Έν•©λ‹λ‹¤. μΈκ³µμ§€λ¥μ€ μ΄ 'μ†λ¦¬ μ§€λ¬Έ'μ„ λ³΄κ³  ν‚¤μ›λ“λ¥Ό νλ³„ν•©λ‹λ‹¤.

### 3.2 μ‹¤μ „ μ¶”λ΅ μ 'μ§€λ¦„κΈΈ' (Direct Injection)
ν„μ¬ λΌμ¦λ² λ¦¬νμ΄(`server_pi_socket_copy.py`)μ—μ„λ” `.pb` λ‚΄λ¶€μ μ „μ²λ¦¬ λΈ”λ΅μ„ κ±΄λ„λ›°κ³  μ‹ κ²½λ§ λ³Έμ²΄μ— λ°μ΄ν„°λ¥Ό μ§μ ‘ μ£Όμ…ν•©λ‹λ‹¤.
- **μ£Όμ… λ…Έλ“:** `frozen_model/Reshape:0`
- **μ¥μ :** μ—°μ‚° ν¨μ¨μ„± κ·Ήλ€ν™” λ° μ‹¤μ‹κ°„ μ¤νΈλ¦¬λ° λ²„νΌ μ²λ¦¬ μ©μ΄

---

## 4. λ…λ Ήμ¤„ μΈμ (μ£Όμ” ν•­λ©)

| μΈμ | κΈ°λ³Έκ°’ | μ„¤λ… |
|------|--------|------|
| `--sample_rate` | 16000 | μ¤λ””μ¤ μƒν”λ μ΄νΈ |
| `--window_size_ms` | 40.0 | μ¤ν™νΈλ΅κ·Έλ¨ μλ„μ° (ν•™μµ μ‹μ™€ λ™μΌν•΄μ•Ό ν•¨) |
| `--window_stride_ms` | 20.0 | μ¤ν™νΈλ΅κ·Έλ¨ μ¤νΈλΌμ΄λ“ |
| `--dct_coefficient_count` | 10 | MFCC κ³„μ μ |
| `--start_checkpoint` | (ν•„μ) | μµμ°μ μ²΄ν¬ν¬μΈνΈ κ²½λ΅ |
| `--output_file` | (ν•„μ) | μ¶λ ¥λ  `.pb` νμΌ κ²½λ΅ |

---

## 5. β… μµμΆ… λ°°ν¬ νμ΄ν”„λΌμΈ (TFLite λ―Έμ‚¬μ©)

ν„μ¬ μ°λ¦¬ ν”„λ΅μ νΈλ” **TFLiteλ¥Ό μ‚¬μ©ν•μ§€ μ•κ³  `.pb` νμΌμ„ μ§μ ‘ μ‚¬μ©**ν•©λ‹λ‹¤.

```
[PC] train.py (ν•™μµ) β†’ freeze.py (λ™κ²°) 
                             β†“
[Pi] server_pi_socket.py (μν–‰) β† ds_cnn_korean_frozen.pb λ΅λ“
```

### β“ μ™ TFLiteλ¥Ό μ“°μ§€ μ•λ‚μ”?
1.  **μ—°μ‚° νΈν™μ„±:** TFLite μ—”μ§„μ€ μ¤λ””μ¤ μ „μ²λ¦¬μ— ν•„μ”ν• `contrib_audio` μ—°μ‚°μ„ μ§€μ›ν•μ§€ μ•μµλ‹λ‹¤.
2.  **μ •ν™•λ„ λ³΄μ΅΄:** `.pb` λ¨λΈμ€ `Float32` μ›λ³Έ κ°€μ¤‘μΉλ¥Ό κ·Έλ€λ΅ μ‚¬μ©ν•μ—¬ ν•™μµ μ‹μ λ†’μ€ μ •ν™•λ„(99.99%)λ¥Ό λΌμ¦λ² λ¦¬νμ΄μ—μ„λ„ 100% λ™μΌν•κ² μ μ§€ν•©λ‹λ‹¤.
3.  **ν™κ²½ κ²©λ¦¬:** `Docker`λ¥Ό ν†µν•΄ λΌμ¦λ² λ¦¬νμ΄μ—μ„λ„ TensorFlow 1.15λ¥Ό μ•μ •μ μΌλ΅ κµ¬λ™ν•  μ μκ² λμ–΄, κµ³μ΄ μ ν•μ μΈ TFLiteλ΅ λ³€ν™ν•  ν•„μ”κ°€ μ—†μ–΄μ΅μµλ‹λ‹¤.
